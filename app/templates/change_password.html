{% extends 'layout.html' %}
{% block title %}Change Password{% endblock %}
{% block body %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <div class="card shadow">
      <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <h3 class="mb-0"><i class="fas fa-key"></i> Change Password</h3>
        <a href="/profile" class="btn btn-outline-light btn-sm">
          <i class="fas fa-arrow-left"></i> Back to Profile
        </a>
      </div>
      <div class="card-body">
        <form id="change-password-form">
          <div class="mb-3">
            <label for="current-password" class="form-label">Current Password <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-lock"></i></span>
              <input type="password" class="form-control" id="current-password" placeholder="Enter your current password" required />
            </div>
          </div>
          <div class="mb-3">
            <label for="new-password" class="form-label">New Password <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-key"></i></span>
              <input type="password" class="form-control" id="new-password" placeholder="Create a new secure password" required minlength="8" />
            </div>
            <div class="form-text">
              <small>Password must contain:
                <ul class="mb-0 small">
                  <li>At least 8 characters</li>
                  <li>One uppercase letter</li>
                  <li>One lowercase letter</li>
                  <li>One number</li>
                </ul>
              </small>
            </div>
            <div id="password-strength" class="mt-1"></div>
          </div>
          <div class="mb-4">
            <label for="confirm-password" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-check"></i></span>
              <input type="password" class="form-control" id="confirm-password" placeholder="Confirm your new password" required />
            </div>
            <div id="password-match" class="mt-1"></div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-warning btn-lg text-dark">
              <i class="fas fa-save"></i> Update Password
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Password strength validation
document.getElementById('new-password').addEventListener('input', function() {
  const password = this.value;
  const strengthDiv = document.getElementById('password-strength');
  
  let strength = 0;
  let feedback = [];
  
  if (password.length >= 8) strength++;
  else feedback.push('At least 8 characters');
  
  if (/[A-Z]/.test(password)) strength++;
  else feedback.push('One uppercase letter');
  
  if (/[a-z]/.test(password)) strength++;
  else feedback.push('One lowercase letter');
  
  if (/\d/.test(password)) strength++;
  else feedback.push('One number');
  
  const colors = ['danger', 'danger', 'warning', 'info', 'success'];
  const texts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
  
  if (password.length > 0) {
    strengthDiv.innerHTML = `
      <div class="progress mb-1" style="height: 5px;">
        <div class="progress-bar bg-${colors[strength]}" style="width: ${strength * 25}%"></div>
      </div>
      <small class="text-${colors[strength]}">${texts[strength]} ${feedback.length > 0 ? '- Missing: ' + feedback.join(', ') : ''}</small>
    `;
  } else {
    strengthDiv.innerHTML = '';
  }
  
  // Also check password match when new password changes
  checkPasswordMatch();
});

// Password match validation
function checkPasswordMatch() {
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const matchDiv = document.getElementById('password-match');
  
  if (confirmPassword.length > 0) {
    if (newPassword === confirmPassword) {
      matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check"></i> Passwords match</small>';
    } else {
      matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times"></i> Passwords do not match</small>';
    }
  } else {
    matchDiv.innerHTML = '';
  }
}

document.getElementById('confirm-password').addEventListener('input', checkPasswordMatch);

document.getElementById('change-password-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const currentPassword = document.getElementById('current-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  
  // Client-side validation
  if (newPassword !== confirmPassword) {
    if(window.showAlert) window.showAlert('Passwords do not match','danger');
    return;
  }
  
  if (newPassword.length < 8 || !/[A-Z]/.test(newPassword) || !/[a-z]/.test(newPassword) || !/\d/.test(newPassword)) {
    if(window.showAlert) window.showAlert('New password does not meet requirements','danger');
    return;
  }
  
  const res = await fetch('/api/auth/change-password', {
    method: 'PUT',
    credentials: 'include',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({current_password: currentPassword, new_password: newPassword})
  });
  
  const j = await res.json();
  if(res.ok) {
    if(window.showAlert) window.showAlert('Password updated successfully!','success');
    setTimeout(() => location.href = '/profile', 1500);
  } else {
    if(window.showAlert) window.showAlert(j.error || 'Failed to update password','danger');
  }
});
</script>
{% endblock %}