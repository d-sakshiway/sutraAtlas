{% extends 'layout.html' %}
{% block title %}Collection{% endblock %}
{% block body %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="/collections">Collections</a></li>
        <li class="breadcrumb-item active" aria-current="page" id="collection-breadcrumb">Loading...</li>
      </ol>
    </nav>
    <h1 id="cname"><i class="fas fa-folder-open"></i> Collection</h1>
  </div>
  <button id="add" class="btn btn-primary">
    <i class="fas fa-plus"></i> Add Resource
  </button>
</div>

<!-- Search and Filter Section -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" class="form-control" id="search-input" placeholder="Search resources...">
        </div>
      </div>
      <div class="col-md-2">
        <select class="form-select" id="status-filter">
          <option value="">All Statuses</option>
          <option value="Not Started">Not Started</option>
          <option value="In Progress">In Progress</option>
          <option value="Paused">Paused</option>
          <option value="Completed">Completed</option>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" id="sort-select">
          <option value="created_at">Sort by Date</option>
          <option value="title">Sort by Title</option>
          <option value="status">Sort by Status</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-secondary" id="clear-filters">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover" id="resources-table">
    <thead class="table-dark">
      <tr>
        <th>Title</th>
        <th>Authors</th>
        <th>Status</th>
        <th>URL</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="resources">
    </tbody>
  </table>
</div>

<div id="no-resources" class="text-center text-muted py-5" style="display: none;">
  <i class="fas fa-book-open fa-3x mb-3"></i>
  <h4>No resources yet</h4>
  <p>Add your first resource to get started!</p>
</div>
<script>
async function load(){
  const id = window.location.pathname.split('/').pop();
  const res = await fetch('/api/collections/'+id, {credentials:'include'});
  if(!res.ok) return location.href='/collections';
  const data = await res.json();
  document.getElementById('cname').innerText = data.collection.name;
  document.getElementById('collection-breadcrumb').innerText = data.collection.name;
  
  // Build search params
  const searchQuery = document.getElementById('search-input')?.value || '';
  const statusFilter = document.getElementById('status-filter')?.value || '';
  const sortBy = document.getElementById('sort-select')?.value || 'created_at';
  
  const params = new URLSearchParams();
  if(searchQuery) params.append('q', searchQuery);
  if(statusFilter) params.append('status', statusFilter);
  if(sortBy) params.append('sort', sortBy);
  
  const resourceUrl = '/api/collections/'+id+'/resources' + (params.toString() ? '?' + params.toString() : '');
  const rres = await fetch(resourceUrl, {credentials:'include'});
  if(rres.ok){
    const rd = await rres.json();
    const tbody = document.getElementById('resources');
    const noResourcesDiv = document.getElementById('no-resources');
    const tableDiv = document.querySelector('.table-responsive');
    
    tbody.innerHTML = '';
    
    if(rd.resources.length === 0) {
      tableDiv.style.display = 'none';
      noResourcesDiv.style.display = 'block';
      const searchQuery = document.getElementById('search-input')?.value || '';
      const statusFilter = document.getElementById('status-filter')?.value || '';
      
      if(searchQuery || statusFilter) {
        noResourcesDiv.innerHTML = `
          <i class="fas fa-search fa-3x mb-3"></i>
          <h4>No resources found</h4>
          <p>Try adjusting your search terms or filters.</p>
        `;
      } else {
        noResourcesDiv.innerHTML = `
          <i class="fas fa-book-open fa-3x mb-3"></i>
          <h4>No resources yet</h4>
          <p>Add your first resource to get started!</p>
        `;
      }
    } else {
      tableDiv.style.display = 'block';
      noResourcesDiv.style.display = 'none';
      
      rd.resources.forEach(r => {
        const tr = document.createElement('tr');
        
        // Format created date
        const createdDate = r.created_at ? new Date(r.created_at).toLocaleDateString() : 'Unknown';
        
        // Format URL link
        let urlHtml = '';
        if(r.url && r.url.trim()) {
          const url = r.url.trim();
          // Ensure URL has protocol
          const fullUrl = url.startsWith('http') ? url : 'https://' + url;
          urlHtml = `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                      <i class="fas fa-external-link-alt"></i> Link
                     </a>`;
        } else {
          urlHtml = '<span class="text-muted">No URL</span>';
        }
        
        // Format status with badge
        const statusClass = {
          'Not Started': 'bg-secondary',
          'In Progress': 'bg-primary',
          'Paused': 'bg-warning',
          'Completed': 'bg-success'
        };
        const statusBadge = `<span class="badge ${statusClass[r.status] || 'bg-secondary'}">${r.status || 'Not Started'}</span>`;
        
        tr.innerHTML = `
          <td><strong>${r.title}</strong></td>
          <td>${r.authors || '<span class="text-muted">No authors</span>'}</td>
          <td>${statusBadge}</td>
          <td>${urlHtml}</td>
          <td class="text-muted small">${createdDate}</td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-outline-warning btn-sm edit-resource" data-resource-id="${r.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-danger btn-sm delete-resource" data-resource-id="${r.id}" data-resource-title="${r.title}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      // Add event listeners for edit and delete
      document.querySelectorAll('.edit-resource').forEach(button => {
        button.addEventListener('click', (e) => {
          const resourceId = e.target.closest('button').dataset.resourceId;
          location.href = `/resources/${resourceId}/edit`;
        });
      });
      
      document.querySelectorAll('.delete-resource').forEach(button => {
        button.addEventListener('click', async (e) => {
          const resourceId = e.target.closest('button').dataset.resourceId;
          const resourceTitle = e.target.closest('button').dataset.resourceTitle;
          
          if (confirm(`Are you sure you want to delete "${resourceTitle}"? This action cannot be undone.`)) {
            const res = await fetch(`/api/resources/${resourceId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            
            if (res.ok) {
              if(window.showAlert) window.showAlert('Resource deleted successfully!', 'success');
              load(); // Reload the table
            } else {
              if(window.showAlert) window.showAlert('Failed to delete resource', 'danger');
            }
          }
        });
      });
    }
  }
}
// Search and filter event listeners
document.getElementById('search-input').addEventListener('input', () => {
  clearTimeout(window.searchTimeout);
  window.searchTimeout = setTimeout(load, 300); // Debounce search
});

document.getElementById('status-filter').addEventListener('change', load);
document.getElementById('sort-select').addEventListener('change', load);

document.getElementById('clear-filters').addEventListener('click', () => {
  document.getElementById('search-input').value = '';
  document.getElementById('status-filter').value = '';
  document.getElementById('sort-select').value = 'created_at';
  load();
});

document.getElementById('add').addEventListener('click', ()=> location.href=window.location.pathname+'/resources/new')
load();
</script>
{% endblock %}
